name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check Python syntax
        run: python -m py_compile rootfs/usr/src/app/server.py

      - name: Validate YAML files
        run: |
          pip install pyyaml
          python -c "
          import yaml
          import sys
          files = ['config.yaml', 'build.yaml', 'repository.yaml', 'translations/en.yaml']
          for f in files:
              try:
                  yaml.safe_load(open(f))
                  print(f'✓ {f}')
              except Exception as e:
                  print(f'✗ {f}: {e}')
                  sys.exit(1)
          "

  build:
    name: Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - amd64
          - aarch64
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          build-args: |
            BUILD_FROM=ghcr.io/home-assistant/${{ matrix.arch }}-base-python:3.11-alpine3.18
          tags: local/dashboard-streams:${{ matrix.arch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-start:
    name: Test Startup
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build \
            --build-arg BUILD_FROM=ghcr.io/home-assistant/amd64-base-python:3.11-alpine3.18 \
            -t local/dashboard-streams:test .

      - name: Create test config
        run: |
          mkdir -p /tmp/test-data
          cat > /tmp/test-data/options.json << 'EOF'
          {
            "dashboard_url": "https://demo.home-assistant.io",
            "access_token": "",
            "kiosk_mode": false,
            "dark_mode": true
          }
          EOF

      - name: Test container starts
        run: |
          # Start container in background
          docker run -d \
            --name test-addon \
            -v /tmp/test-data:/data \
            -p 8099:8099 \
            local/dashboard-streams:test

          # Wait for startup
          echo "Waiting for container to start..."
          sleep 10

          # Check if container is still running
          if docker ps | grep -q test-addon; then
            echo "✓ Container is running"
          else
            echo "✗ Container failed to start"
            docker logs test-addon
            exit 1
          fi

          # Check if web server responds
          echo "Checking web server..."
          if curl -sf http://localhost:8099/health > /dev/null 2>&1; then
            echo "✓ Web server is responding"
            curl -s http://localhost:8099/health | jq .
          else
            echo "⚠ Web server not responding yet (may need more time for Chromium)"
            docker logs test-addon | tail -50
          fi

          # Cleanup
          docker stop test-addon
          docker rm test-addon
